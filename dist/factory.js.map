{"version":3,"sources":["../libs/factory.js"],"names":["lowLevel","highLevel","host","method","rules","url","params","initRequest","callback","toLowerCase","opts","middleware","options","isObject","all","headers","Object","keys","forEach","k","isAbsUri","resolve","json","undefined","Resolve","Reject","req","set","accept","type","qs","query","body","send","end","err","res","status","header","code","text","customError","customBody","response","obj","uri","indexOf"],"mappings":"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","file":"factory.js","sourcesContent":["import url from 'url'\nimport merge from 'lodash.merge'\nimport cloneDeep from 'lodash.clonedeep'\nimport isFunction from 'lodash.isfunction'\nimport lodashIsObject from 'lodash.isobject'\nimport debug from 'debug'\nimport Promise from 'bluebird'\nimport request from 'superagent'\nimport urlmaker from './url'\n\nexport function lowLevel(host, method, rules) {\n  return (url, params={}) => {\n    // Return a Promise/A+\n    return initRequest({\n      host,\n      url,\n      method,\n      rules,\n    }, params)\n  }\n}\n\nexport function highLevel(host, { url, method, callback }, rules) {\n  return (params={}) => {\n    // Return a Promise/A+\n    return initRequest({\n      host,\n      rules,\n      url: urlmaker(url, params),\n      method: method ? method.toLowerCase() : 'get',\n    }, params, callback)\n  }\n}\n\nfunction initRequest(opts, params, middleware) {\n  var rules = opts.rules\n  var options = isObject(params) ? params : {}\n\n  if (rules) {\n    if (rules.all)\n      options = merge(cloneDeep(rules.all), options)\n    if (rules[opts.method])\n      options = merge(cloneDeep(rules[opts.method]), options)\n\n    if (options.headers) {\n      Object.keys(options.headers).forEach(k => {\n        if (typeof(options.headers[k]) === 'function')\n          options.headers[k] = options.headers[k]()\n      })\n    }\n  }\n\n  options.method = opts.method\n  options.url = isAbsUri(opts.url) ?\n    opts.url : url.resolve(opts.host, opts.url);\n\n  if (options.json == undefined)\n    options.json = true\n\n  debug('sdk:request')(options)\n\n  return new Promise((Resolve, Reject) => {\n    let req = request[options.method](options.url);\n\n    if (options.headers)\n      req.set(options.headers)\n    if (options.json)\n      req.accept('json').type('json')\n    if (options.qs)\n      req.query(options.qs)\n    if (options.body)\n      req.send(options.body)\n\n    req.end((err, res) => {\n      if (err)\n        return Reject(res)\n\n      debug('sdk:response:status')(res.status)\n      debug('sdk:response:headers')(res.header)\n      debug('sdk:response:body')(res.body)\n\n      let code = res.status;\n      let body = res.body || res.text;\n\n      if (isFunction(middleware)) {\n        return middleware(res, body, (customError, customBody) => {\n          if (customError)\n            return Reject(customError)\n\n          return Resolve({\n            code,\n            response: res,\n            body: customBody || body\n          })\n        })\n      }\n\n      return Resolve({\n        code,\n        response: res,\n        body\n      })\n    })\n\n    return req\n  })\n}\n\nfunction isObject(obj) {\n  return obj && lodashIsObject(obj) && !isFunction(obj)\n}\n\nfunction isAbsUri(uri) {\n  return uri && (uri.indexOf('http') === 0 || uri.indexOf('https') === 0)\n}\n"]}